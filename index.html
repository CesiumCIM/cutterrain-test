<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Cesium 断面化デモ（右半分のみ表示）</title>
  <script src="https://unpkg.com/cesium@1.89/Build/Cesium/Cesium.js"></script>
  <link href="https://unpkg.com/cesium@1.89/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer {
      margin:0; padding:0; width:100%; height:100%; overflow:hidden;
    }
    #toggleBtn {
      position:absolute; top:10px; left:10px; padding:8px 12px; font-size:14px; z-index:100;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="toggleBtn">地球儀 OFF</button>
  <script>
    Cesium.Ion.defaultAccessToken =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhZDE3MjMyZi01MThlLTQxOGQtOTM4ZC1iYjBlODFiMGM2Y2UiLCJpZCI6MjQ1NzQ4LCJpYXQiOjE3Mjc5NzY3ODJ9.pNoxj3_erzKOuSjKyj2A_LQXESK_jk9hg692mvX_3G0';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: Cesium.createWorldTerrain(),
      animation: false,
      timeline: false,
      infoBox: false,
      selectionIndicator: false
    });

    let terrainOn = true;
    document.getElementById('toggleBtn').addEventListener('click', () => {
      terrainOn = !terrainOn;
      viewer.terrainProvider = terrainOn
        ? new Cesium.EllipsoidTerrainProvider()
        : Cesium.createWorldTerrain();
      document.getElementById('toggleBtn').textContent = terrainOn ? '地球儀 ON' : '地球儀 OFF';
    });

    let tileset, clipPlanes;
    Cesium.IonResource.fromAssetId(3308455).then(res => {
      clipPlanes = new Cesium.ClippingPlaneCollection({
        planes: [],
        edgeColor: Cesium.Color.RED,
        edgeWidth: 2.0,
        unionClippingRegions: true
      });
      tileset = new Cesium.Cesium3DTileset({
        url: res,
        clippingPlanes: clipPlanes
      });
      viewer.scene.primitives.add(tileset);
      tileset.readyPromise.then(() => viewer.zoomTo(tileset));
    });

    let drawing = false;
    let startPos = null;

    const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    handler.setInputAction((evt) => {
      drawing = true;
      startPos = evt.position;
    }, Cesium.ScreenSpaceEventType.LEFT_DOWN);

    handler.setInputAction((evt) => {
      if (!drawing) return;
      drawing = false;
      const endPos = evt.position;

      const startCarto = viewer.scene.globe.pick(viewer.camera.getPickRay(startPos), viewer.scene);
      const endCarto = viewer.scene.globe.pick(viewer.camera.getPickRay(endPos), viewer.scene);
      if (!startCarto || !endCarto) return;

      const start = startCarto;
      const end = endCarto;

      // 方向ベクトル（XY平面）
      const dir = Cesium.Cartesian3.normalize(
        Cesium.Cartesian3.subtract(end, start, new Cesium.Cartesian3()),
        new Cesium.Cartesian3()
      );
      // 右側法線
      const normal = Cesium.Cartesian3.normalize(
        new Cesium.Cartesian3(-dir.y, dir.x, 0),
        new Cesium.Cartesian3()
      );
      const distance = -Cesium.Cartesian3.dot(normal, start);

      clipPlanes.removeAll();
      clipPlanes.add(new Cesium.ClippingPlane(normal, distance));
    }, Cesium.ScreenSpaceEventType.LEFT_UP);

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        clipPlanes.removeAll();
        drawing = false;
      }
    });
  </script>
</body>
</html>
