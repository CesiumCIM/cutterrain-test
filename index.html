<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Cesium 断面化デモ</title>
  <script src="https://unpkg.com/cesium@1.89/Build/Cesium/Cesium.js"></script>
  <link href="https://unpkg.com/cesium@1.89/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    #toggleBtn { position:absolute; top:10px; left:10px; z-index:100; padding:8px; }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="toggleBtn">地球儀 OFF</button>
  <script>
    Cesium.Ion.defaultAccessToken = 'eyJh...';
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: Cesium.createWorldTerrain(),
      timeline: false, animation: false,
      infoBox: false, selectionIndicator: false
    });

    let terrainOn = true;
    document.getElementById('toggleBtn').onclick = () => {
      viewer.terrainProvider = terrainOn ? new Cesium.EllipsoidTerrainProvider() : Cesium.createWorldTerrain();
      terrainOn = !terrainOn;
      document.getElementById('toggleBtn').textContent = terrainOn ? '地球儀 OFF' : '地球儀 ON';
    };

    let tileset, clipPlanes;
    Cesium.IonResource.fromAssetId(3308455).then(res => {
      clipPlanes = new Cesium.ClippingPlaneCollection({ planes:[], edgeColor: Cesium.Color.RED, edgeWidth: 2 });
      tileset = new Cesium.Cesium3DTileset({ url: res, clippingPlanes: clipPlanes });
      viewer.scene.primitives.add(tileset);
      tileset.readyPromise.then(() => viewer.zoomTo(tileset));
    });

    let startPos, drawing=false;
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    handler.setInputAction(c => { startPos = c.position; drawing=true; }, Cesium.ScreenSpaceEventType.LEFT_DOWN);
    handler.setInputAction(c => {
      if (!drawing) return;
      drawing=false;
      const endPos = c.position;
      const startCartesian = viewer.scene.globe.pick(viewer.camera.getPickRay(startPos), viewer.scene);
      const endCartesian = viewer.scene.globe.pick(viewer.camera.getPickRay(endPos), viewer.scene);
      if (!startCartesian||!endCartesian) return;

      const start = Cesium.Cartographic.toCartesian(Cesium.Cartographic.fromCartesian(startCartesian));
      const end = Cesium.Cartographic.toCartesian(Cesium.Cartographic.fromCartesian(endCartesian));
      const dir = Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(end,start,new Cesium.Cartesian3()), new Cesium.Cartesian3());
      const normal2d = Cesium.Cartesian3.normalize(new Cesium.Cartesian3(-dir.y, dir.x, 0), new Cesium.Cartesian3());
      const distance = -Cesium.Cartesian3.dot(normal2d, start);

      clipPlanes.removeAll();
      clipPlanes.add(new Cesium.ClippingPlane(normal2d, distance));
    }, Cesium.ScreenSpaceEventType.LEFT_UP);

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') clipPlanes.removeAll();
    });
  </script>
</body>
</html>
